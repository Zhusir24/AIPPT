// ** React Imports
import { useState, useEffect } from 'react';

// ** MUI Imports
import Typography from '@mui/material/Typography'; // Importing Typography
import toast from 'react-hot-toast';
import Box from '@mui/material/Box';
import TextField from '@mui/material/TextField';
import Button from '@mui/material/Button';
import Grid from '@mui/material/Grid';
import InputAdornment from '@mui/material/InputAdornment';
import LinkIcon from '@mui/icons-material/Link';
import ModelTrainingIcon from '@mui/icons-material/ModelTraining';
import KeyIcon from '@mui/icons-material/Key';
import SaveIcon from '@mui/icons-material/Save';

import { BackendApi } from './Config'

const Setting = () => {
  // ** States

  // 状态管理
  const [aiApiUrl, setAiApiUrl] = useState(""); // 输入框内容
  const [aiModel, setAiModel] = useState(""); // 输入框内容
  const [aiToken, setAiToken] = useState(""); // 输入框内容

  // 处理立即生成按钮点击
  const handleSaveConfig = async () => {
    try {
      const response = await fetch(BackendApi + 'saveConfig.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ aiApiUrl, aiModel, aiToken })
      });

      const responseData = await response.json();

      if (responseData.status === 'ok') {
        toast.success(responseData.msg);
      } else {
        toast.error(responseData.msg);
      }
    } catch (error: any) {
      toast.error(error.message || '保存配置时发生错误');
    }
  };

  // Fetch configuration on component mount
  useEffect(() => {
    const fetchConfig = async () => {
      try {
        const response = await fetch(BackendApi + 'saveConfig.php?action=getConfig');
        const data = await response.json();
        console.log("data", data)
        if (data.status === 'ok') {
          setAiApiUrl(data.API_URL || "");
          setAiModel(data.API_MODE || "");
        } else {
          toast.error(data.msg);
        }
      } catch (error) {
        toast.error((error as Error).message || '获取配置时发生错误');
      }
    };

    fetchConfig();
  }, []);

  return (
    <Box sx={{ py: 5, px: 10 }}>
      <TextField
        fullWidth
        label="AI API URL"
        variant="outlined"
        value={aiApiUrl}
        onChange={(e) => setAiApiUrl(e.target.value)}
        sx={{ mt: 2, mb: 2 }} // Adjusted width for smaller field
        InputProps={{
          startAdornment: (
            <InputAdornment position="start">
              <LinkIcon />
            </InputAdornment>
          ),
        }}
        helperText="例如: https://api.deepseek.com 注意: 系统会自动在URL的后面追加: /chat/completions " // Added helper text
      />
      <TextField
        fullWidth
        label="AI Model"
        variant="outlined"
        value={aiModel}
        onChange={(e) => setAiModel(e.target.value)}
        sx={{ mt: 2, mb: 2 }} // Adjusted width for smaller field
        InputProps={{
          startAdornment: (
            <InputAdornment position="start">
              <ModelTrainingIcon />
            </InputAdornment>
          ),
        }}
        helperText="例如: deepseek-chat" // Added helper text
      />
      <TextField
        fullWidth
        label="AI Token"
        variant="outlined"
        value={aiToken}
        onChange={(e) => setAiToken(e.target.value)}
        sx={{ mt: 2, mb: 2 }} // Adjusted width for smaller field
        InputProps={{
          startAdornment: (
            <InputAdornment position="start">
              <KeyIcon />
            </InputAdornment>
          ),
        }}
        helperText="例如: sk-6deec20***********, 请输入你自己的KEY, 如果不需要KEY, 则输入一个任意值就可以." // Added helper text
      />
      <Typography variant="body2" sx={{ mt: 2, mb: 2 }}>1 支持DeepSeek官方API</Typography>
      <Typography variant="body2" sx={{ mt: 2, mb: 2 }}>2 支持OpenAI官方以及第三方兼容API</Typography>
      <Typography variant="body2" sx={{ mt: 2, mb: 2 }}>3 目前只能在 http://localhost 访问的时候,才可以进行保存参数</Typography>
      <Typography variant="body2" sx={{ mt: 2, mb: 2 }}>4 为了安全期间, 不会显示系统已有Token的值</Typography>
      <Grid container justifyContent="center" sx={{ pt: 5, mt: 2, mb: 2 }}>
        <Grid item>
          <Button
            variant="contained"
            color="primary"
            onClick={handleSaveConfig}
            startIcon={<SaveIcon />}
          >
            修改配置
          </Button>
        </Grid>
      </Grid>
    </Box>
  )
}

export default Setting
